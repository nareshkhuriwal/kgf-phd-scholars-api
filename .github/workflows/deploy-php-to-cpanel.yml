name: Deploy KGF Scholars Backend to cPanel (Shared Hosting)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) Setup PHP for Laravel build â€” use PHP 8.4 (matches composer.lock)
      - name: Setup PHP 8.4
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, intl, pdo_mysql, bcmath, xml, zip
          coverage: none

      # 2.1) Composer cache (optional but recommended)
      - name: Setup composer cache
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      # 3) Install composer dependencies (no dev)
      - name: Install Composer dependencies
        run: |
          composer --version
          composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader

      # 4) (Optional) Build frontend assets
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build frontend assets
        run: |
          if [ -f package.json ]; then
            npm ci
            npm run build
          fi

      # 5) Prepare deployment package (exclude things we don't want on server)
      - name: Prepare deployment files
        run: |
          mkdir deploy
          rsync -av --exclude=".git" \
                   --exclude=".github" \
                   --exclude="node_modules" \
                   --exclude="tests" \
                   --exclude=".env" \
                   --exclude="vendor" \
                   --exclude="storage" \
                   --exclude="public" \
                   ./ ./deploy

      # 6) Normalize server dir environment
      - name: Normalize server dir
        run: |
          SD="${{ secrets.CPANEL_FTP_PATH }}"
          if [ -z "$SD" ]; then
            echo "No CPANEL_FTP_PATH secret set; aborting."
            exit 1
          fi
          case "$SD" in
            */) echo "SERVER_DIR=$SD" >> $GITHUB_ENV ;;
            *)  echo "SERVER_DIR=${SD}/" >> $GITHUB_ENV ;;
          esac

      - name: Show deployment package (local debug)
        run: |
          echo "Working dir: $(pwd)"
          echo "deploy/ listing:"
          ls -la deploy || echo "deploy/ not found"
          echo ""
          if [ ! -d deploy ] || [ -z "$(ls -A deploy 2>/dev/null)" ]; then
            echo "Error: deploy/ is missing or empty. Aborting."
            exit 1
          fi

      - name: Show SERVER_DIR (masked)
        run: |
          echo "SERVER_DIR=$SERVER_DIR"

      - name: List remote FTP dir (debug)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y lftp
          echo "Listing remote: $SERVER_DIR"
          lftp -u "${{ secrets.CPANEL_FTP_USERNAME }}","${{ secrets.CPANEL_FTP_PASSWORD }}" "${{ secrets.CPANEL_FTP_HOST }}" -e "cls -la ${SERVER_DIR}; bye" || echo "Remote listing failed (check host/creds)"

      - name: Deploy to cPanel via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.CPANEL_FTP_HOST }}
          username: ${{ secrets.CPANEL_FTP_USERNAME }}
          password: ${{ secrets.CPANEL_FTP_PASSWORD }}
          local-dir: ./deploy/
          server-dir: ${{ env.SERVER_DIR }}
          dangerous-clean-slate: false
